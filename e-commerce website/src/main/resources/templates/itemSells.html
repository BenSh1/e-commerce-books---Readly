<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" name="_csrf" th:content="${_csrf.token}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <div>
        <a th:href="@{/showMyLoginPage}" class="btn btn-primary mt-3" role="button" aria-pressed="true">Sign-in</a>
    </div>
    <div>
        <a th:href="@{/register/showRegistrationForm}" class="btn btn-primary mt-3" role="button" aria-pressed="true">Sign-up</a>
    </div>
    <div>
        <a th:href="@{/home}" class="btn btn-primary mt-3" role="button" aria-pressed="true">Home</a>
    </div>
    <div>
        <a th:href="@{/}" class="btn btn-primary mt-3" role="button" aria-pressed="true">Landing Page</a>
    </div>
    <div>
        <p>
            <a th:href="@{cart}">go to cart</a>
        </p>
    </div>

    <hr>

    <title>Items for Sale</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .item-list {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .item {
            border: 1px solid #ddd;
            padding: 10px;
            width: 250px;
            text-align: center;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
        }
        .item img {
            max-width: 100%;
            /*height: auto;*/
        }
        .item h3 {
            margin: 10px 0;
            font-size: 1.2em;
        }
        .item p {
            margin: 10px 0;
            color: #555;
        }
        .item .price {
            font-weight: bold;
            color: #d9534f;
        }

        /* Styles for "buy page" and "add to the cart" links */
        .item p a {
            color: #007bff; /* Blue color for the links */
            text-decoration: none; /* Remove underline */
            padding: 5px 10px; /* Add some padding */
            border: 1px solid #ddd; /* Add a thin border */
            border-radius: 3px; /* Rounded corners */
            margin: 5px; /* Add some space between links */
        }

        .item p a:hover { /* Styles on hover */
            background-color: #ddd; /* Light gray background on hover */
        }

        #cart-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        #cart-message-content {
            margin: 0;
            padding: 0;
        }

        #cart-message button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
        }

        #cart-message button:hover {
            background-color: #0056b3;
        }
    </style>

    <!--
    <script>
        function addToCart(bookId) {
            fetch(`/cart/add/${bookId}`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        alert('Book added to cart!');
                    } else {
                        alert('Failed to add book to cart.');

                    }
                });
        }
    </script>
    -->
    <!--
    <script>
        function hideMessage() {
            console.log("hideMessage function called");
            const messageDiv = document.getElementById('message');
            if (messageDiv) {
                console.log("Message div found");
                setTimeout(() => {
                    console.log("Hiding message div");
                    messageDiv.style.display = 'none';
                }, 3000); // Hide after 3 seconds
            } else {
                console.log("Message div not found");
            }
        }

        window.onload = hideMessage;
    </script>
    -->


    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var feedbackMessage = document.getElementById("feedbackMessage");
            if (feedbackMessage) {
                setTimeout(function() {
                    feedbackMessage.style.display = 'none';
                }, 5000); // Hide after 5 seconds
            }
        });
    </script>


</head>

<body>
<!--
<div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
-->

<form th:action="@{/search}" method="get">
    <input type="text" name="query" placeholder="Search for books...">
    <button type="submit">Search</button>
</form>

<div th:if="${books != null}">
    <h2>Search Results:</h2>
    <ul>
        <li th:each="book : ${books}">
            <form th:action="@{bookDetails/{id}(id=${book.bookId})}">
                <button type="submit">
                    <img th:src="@{'/images/' + ${book.image}}" alt="Book Image" width="250" height="350" /><br/>
                    <input type="hidden" name="bookId" th:value="${book.bookId}">
                </button>
            </form>
            <span th:text="${book.title}">Book Title</span> -
            <span th:text="${book.author}">Author</span>
            <div sec:authorize="hasRole('CUSTOMER')">

                <!-- Add to Cart Button -->
                <form th:action="@{itemSells/{id}(id=${book.bookId})}" method="post">
                    <input type="hidden" th:name="bookId" th:value="${book.bookId}" />
                    <button type="submit">Add to Cart</button>
                </form>
            </div>
        </li>
    </ul>
</div>


<h2>Items for Sale</h2>

<div id="feedbackMessage" th:if="${message}" th:text="${message}" class="alert alert-success"></div>

<div class="item-list">
    <div class="item" th:each="book : ${allBooks} ">
        <form th:action="@{bookDetails/{id}(id=${book.bookId})}">
            <button type="submit">
                <img th:src="@{'/images/' + ${book.image}}" alt="Book Image" width="250" height="350" /><br/>
                <input type="hidden" name="bookId" th:value="${book.bookId}">
            </button>
        </form>
        <!--<h3 th:text="${book.title}">Item Name</h3>-->

        <a th:href="@{/bookDetails/{id}(id=${book.bookId})}"><span style="font-size: 30px;">[[${book.title}]]</span></a>

        <!--<p th:text="${book.description}">Item Description</p>-->
        <p class="price" th:text="'$' + ${book.price}">Item Price</p>

        <form th:action="@{bookDetails/{id}(id=${book.bookId})}">
            <input type="hidden" th:name="bookId" th:value="${book.bookId}" />
            <button type="submit">Details</button>
        </form>

        <div sec:authorize="hasRole('CUSTOMER')">

            <!-- Add to Cart Button -->
            <form th:action="@{itemSells/{id}(id=${book.bookId})}" method="post">
            <!--<form th:action="@{/itemSells/{id}/addToCart(id=${book.bookId})}" method="post">-->
                <input type="hidden" th:name="bookId" th:value="${book.bookId}" />
                <button type="submit">Add to Cart</button>
            </form>


            <!--
            <button onclick="addToCart(' + ${book.bookId} + ')">Add to Cart</button>
            -->
            <!--
            <button class="add-to-cart-button" th:attr="data-book-id=${book.bookId}">Add to Cart</button>
            -->

            <!--
            <button onclick="addToCart([[${book.bookId}]])">Add to Cart</button>
            -->
            <!--
            <button onclick="addToCart([[${book.bookId}]])">Add to Cart</button>
            -->

        </div>

        <!-- there is an issue when i add those lines of codes such as i got denied page access
        even though i gave to this page itemSells permitAll access -->
        <!--
        <form th:action="@{/cart/add}" method="post">
            <input type="hidden" name="cartId" value="1" />
            <input type="hidden" name="bookId" th:value="${book.id}" />
            <input type="number" name="quantity" value="1" min="1" />
            <button type="submit">Add to Cart</button>
        </form>
        -->

        <!--
        <form th:action="@{/cart/add}" method="post">
            <input type="hidden" name="bookId" th:value="${book.id}" />
            <input type="number" name="quantity" value="1" min="1" />
            <button type="submit">Add to Cart</button>
        </form>
        -->

        <!--
        <form th:action="@{/cart/add/{id}(id=${book.bookId})}" method="post">
            <label for="quantity">Quantity:</label>
            <input type="number" id="quantity" name="quantity" min="1" value="1" >
            <button type="submit">Add to Cart</button>
        </form>
        -->
        <!--
        <div sec:authorize="hasRole('CUSTOMER')">
        <p>
            <a href="/cart">buy page</a>
            <button th:attr="onclick=|addToCart(${book.bookId})|">Add to Cart</button>
            <a th:href="@{cart}">add to Cart</a>
        </p>
        </div>
        -->


    </div>
</div>






<!--
<button onclick="buy()">Buy</button>
<a href="/cart"><button>View Cart</button></a>
-->

<!--
<a href="/cart">Go to Cart</a>
<div id="cart-message" style="display: none;">
    <p id="cart-message-content"></p>
    <button onclick="hideCartMessage()">Close</button>
</div>
-->


<script>
    function getCsrfToken() {
        return document.querySelector('meta[name="_csrf"]').getAttribute('content');
    }
/*
    function addToCart(bookId) {
        //fetch(`/api/carts/1/books/${bookId}?quantity=1`, {method: 'POST'})
        fetch("/cart/add/${bookId}", {
            method: 'POST' ,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': getCsrfToken()
            } })
                .then(response => {
            if (response.ok) {
                alert('Book added to cart');
            } else {
                alert("Error adding book to cart.");
            }
        });
    }

 */


    /*
    // Add event listener for buttons
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.add-to-cart-button').forEach(button => {
            button.addEventListener('click', function() {
                const bookId = this.getAttribute('data-book-id');
                addToCart(bookId);
            });
        });
    });

     */
    /*
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.add-to-cart-button').forEach(button => {
            button.addEventListener('click', function() {
                const bookId = this.getAttribute('data-book-id');

                addToCart(bookId);
            });
        });
    });

     */

    function buy() {
        fetch(`/cart/buy`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': getCsrfToken()
            }})
            .then(response => {
                if (response.ok) {
                    alert('Purchase successful!');
                    window.location.href = '/';

                } else {
                    alert('Purchase failed.');
                }
            });
    }

    function showCartMessage(message) {
        document.getElementById('cart-message-content').innerText = message;
        document.getElementById('cart-message').style.display = 'block';
    }

    function hideCartMessage() {
        document.getElementById('cart-message').style.display = 'none';
    }
</script>

</body>
</html>
